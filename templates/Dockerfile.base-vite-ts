FROM node:20-alpine

RUN apk add --no-cache python3 py3-pip git \
 && pip3 install --break-system-packages --no-cache-dir git-remote-s3 \
 && corepack enable

ARG SQUASH_CLI_VERSION=0.0.5
RUN npm install -g @squashai/cli@$SQUASH_CLI_VERSION

WORKDIR /repo

COPY package.json .
COPY pnpm-lock.yaml .

RUN pnpm install

COPY vite.config.js .
COPY tsconfig.json .
COPY index.html .
COPY src/ ./src/
COPY .claude/ .claude/

RUN git init \
 && git add . \
 && git config --global user.email "agent@squash.build" \
 && git config --global user.name "Squash" \
 && git commit -m "Initial commit"

ENV PORT=5173
